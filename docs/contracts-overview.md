# 条件令牌市场做市商合约概览

本文档提供了条件令牌市场做市商相关合约的结构、功能和关系的概览。

## 主要合约及其功能

### 核心做市商合约

#### 1. MarketMaker.sol
- **角色**: 基础市场做市商合约，作为其他做市商的基类
- **功能**:
  - 管理条件令牌的交易和价格功能
  - 提供资金管理（添加/移除）
  - 实现交易功能和费用计算
  - 支持暂停/恢复/关闭市场
  - 支持白名单用户访问控制
- **事件**:
  - `AMMCreated`、`AMMPaused`、`AMMResumed`、`AMMClosed`
  - `AMMFundingChanged`、`AMMFeeChanged`、`AMMFeeWithdrawal`
  - `AMMOutcomeTokenTrade`

#### 2. FixedProductMarketMaker.sol
- **角色**: 固定产品市场做市商合约，实现特定的做市算法
- **功能**:
  - 实现基于固定产品乘积公式的做市算法
  - 提供添加资金、移除资金功能
  - 实现买入和卖出令牌功能
  - 支持费用计算和提取
  - 继承ERC20实现流动性代币功能
- **事件**:
  - `FPMMFundingAdded`、`FPMMFundingRemoved`
  - `FPMMBuy`、`FPMMSell`

#### 3. LMSRMarketMaker.sol
- **角色**: 对数市场评分规则(LMSR)市场做市商合约
- **功能**:
  - 继承自MarketMaker基类
  - 使用对数市场评分规则算法来计算令牌价格
  - 专注于计算交易的净成本和结果的边际价格
  - 适用于预测市场的价格发现

### 工厂合约

#### 4. FPMMDeterministicFactory.sol
- **角色**: 使用CREATE2创建可预测地址的FPMM合约
- **功能**:
  - 继承自Create2CloneFactory
  - 使用CREATE2操作码创建可预测地址的合约
  - 允许初始资金和分布提示设置
  - 处理条件令牌的传输
- **事件**:
  - `FixedProductMarketMakerCreation`

#### 5. FixedProductMarketMakerFactory.sol
- **角色**: 普通FPMM工厂合约
- **功能**:
  - 创建FixedProductMarketMaker实例
  - 提供更简单的创建机制

#### 6. LMSRMarketMakerFactory.sol
- **角色**: LMSR市场做市商的工厂合约
- **功能**:
  - 创建LMSRMarketMaker实例
  - 初始化条件令牌、抵押品令牌和条件ID

### 辅助合约

#### 7. Create2CloneFactory.sol
- **角色**: 提供可预测地址的合约克隆功能
- **功能**:
  - 使用CREATE2操作码实现高效的合约克隆机制
  - 作为FPMMDeterministicFactory的基类
  - 提供确定性地址的合约部署功能

#### 8. ERC20.sol
- **角色**: 标准ERC20代币实现
- **功能**:
  - 提供代币功能（转账、授权等）
  - 被FixedProductMarketMaker继承用于创建市场份额代币

#### 9. Whitelist.sol
- **角色**: 白名单访问控制
- **功能**:
  - 实现访问控制机制
  - 由MarketMaker使用来限制谁可以参与交易

#### 10. Migrations.sol
- **角色**: Truffle迁移合约
- **功能**:
  - 用于管理合约部署迁移

## 合约关系图

```
                           +-------------+
                           |Create2Clone |
                           |  Factory    |
                           +------+------+
                                  |
                                  |继承
                                  |
            +-------------------+-+--------------------+
            |                                          |
+-----------v-----------+              +---------------v---------------+
|FixedProductMarketMaker|              |FPMMDeterministicFactory       |
|Factory                |              |(使用CREATE2创建可预测地址的FPMM)|
+----------+------------+              +---------------+---------------+
           |                                           |
           |创建                                        |创建
           |                                           |
+----------v------------+                 +------------v--------------+
|FixedProductMarketMaker+<----------------+FixedProductMarketMakerData|
|(固定产品做市商)         |  继承             |(代理数据存储)              |
+----------+------------+                 +---------------------------+
           ^
           |
           |使用
           |
+----------v----------+                  +---------------------------+
|     ERC20           |                  |                           |
|(代币标准实现)         |                  |     Whitelist             |
+---------------------+                  |     (白名单控制)            |
                                         +-------------+-------------+
                                                       ^
+---------------------+                                |
|LMSRMarketMakerFactory|                               |使用
|                     |                                |
+---------+-----------+                  +-------------+-------------+
          |                              |                           |
          |创建                           |    MarketMaker            |
          |                              |    (基础做市商)            |
+---------v-----------+                  +-------------+-------------+
|LMSRMarketMaker      |                                ^
|(对数市场评分规则做市商)|                                |继承
+---------------------+                                |
                                         +-------------+-------------+
                                         |LMSRMarketMaker            |
                                         |(对数市场评分规则做市商)      |
                                         +---------------------------+
```

## 工作流程

1. **创建市场**:
   - 使用工厂合约创建做市商实例
   - 指定条件令牌、抵押品令牌和条件ID
   - 设置初始资金和费用

2. **添加流动性**:
   - 用户通过`addFunding()`函数添加抵押品令牌
   - 用户获得流动性代币作为回报
   - 资金根据分布提示或现有池余额分配

3. **交易**:
   - 用户通过`buy()`购买特定结果的令牌
   - 用户通过`sell()`出售特定结果的令牌
   - 价格根据做市算法自动调整

4. **移除流动性**:
   - 用户通过`removeFunding()`燃烧流动性代币
   - 用户按比例收回各种结果的条件令牌

5. **市场关闭**:
   - 市场所有者可以暂停、恢复或关闭市场
   - 关闭市场后，所有剩余令牌转移到所有者地址

## 主要算法

1. **固定产品做市算法(FPMM)**:
   - 基于常数乘积公式: `x * y = k`
   - 适用于二元或多元结果
   - 自动调整价格以反映市场需求

2. **对数市场评分规则(LMSR)**:
   - 基于指数函数计算价格
   - 特别适用于预测市场
   - 考虑到流动性和回报风险

## 总结

这个合约系统提供了一个完整的框架，用于创建和管理条件令牌市场中的自动做市商。通过两种主要的做市算法(FPMM和LMSR)，系统能够为不同类型的预测市场和交易场景提供流动性和价格发现机制。工厂模式的使用使得创建新市场变得简单，而继承结构确保了代码的可重用性和一致性。 