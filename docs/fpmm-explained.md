# FixedProductMarketMaker (FPMM) 详解

固定产品市场做市商(FPMM)是一个智能合约，在条件令牌市场中提供自动化做市功能。本文档详细介绍FPMM的所有功能以及相关使用示例。

## 一、FPMM的基本概念

FPMM基于恒定乘积算法(Constant Product Formula)，类似于Uniswap的自动做市机制，但专为预测市场设计。其核心公式确保在交易前后，所有可能结果的代币池余额的乘积保持不变。

核心特点：
- 实现了无需中心化做市商的自动价格发现
- 支持多结果事件（不仅仅是二元结果）
- 通过LP代币(ERC20)代表流动性提供份额
- 自动化收取和分配交易费用
- 为低概率事件提供较高回报，符合风险-回报对等原则

## 二、FPMM的主要功能详解

### 1. 添加流动性（addFunding）

**功能**: 允许用户向市场添加资金，成为流动性提供者，获得代表其份额的LP代币。

**参数**:
- `addedFunds`: 添加的抵押品金额
- `distributionHint`: 初始资金分配提示数组

**示例场景**:

假设创建了一个足球比赛的预测市场，有3个可能结果：主队胜、平局、客队胜。

```javascript
// 添加1000个DAI作为初始流动性
const addedFunds = web3.utils.toWei('1000', 'ether');
// 初始分配提示：认为各结果概率分别为50%、20%、30%
const distributionHint = [50, 20, 30];
await fpmm.addFunding(addedFunds, distributionHint, { from: investor });
```

**结果**:
- 投资者转入1000 DAI到市场合约
- 投资者获得与投入金额等值的LP代币(1000个)
- 市场根据分配提示分配资金：
  - 主队胜池: 1000 DAI (按最大值分配100%)
  - 平局池: 400 DAI (按最大值分配40%)
  - 客队胜池: 600 DAI (按最大值分配60%)
- 投资者收到未分配到池中的代币：
  - 主队胜代币: 0个
  - 平局代币: 600个
  - 客队胜代币: 400个

### 2. 计算购买数量（calcBuyAmount）

**功能**: 计算给定投资金额能购买多少特定结果的代币。

**参数**:
- `investmentAmount`: 投资金额
- `outcomeIndex`: 想要购买的结果索引

**示例场景**:

用户想知道投入100 DAI，能购买多少"主队胜"(索引0)的结果代币。

```javascript
const investmentAmount = web3.utils.toWei('100', 'ether');
const outcomeIndex = 0; // 主队胜
const outcomeTokensToBuy = await fpmm.calcBuyAmount(investmentAmount, outcomeIndex);
console.log(`投入100 DAI能购买 ${web3.utils.fromWei(outcomeTokensToBuy)} 个主队胜的结果代币`);
```

### 3. 购买结果代币（buy）

**功能**: 使用抵押品购买特定结果的代币。

**参数**:
- `investmentAmount`: 投资金额
- `outcomeIndex`: 要购买的结果索引
- `minOutcomeTokensToBuy`: 期望购买的最少代币数量(滑点保护)

**示例场景**:

用户看好主队胜，决定用100 DAI购买"主队胜"的结果代币。

```javascript
const investmentAmount = web3.utils.toWei('100', 'ether');
const outcomeIndex = 0; // 主队胜
const outcomeTokensToBuy = await fpmm.calcBuyAmount(investmentAmount, outcomeIndex);
// 设置1%的滑点保护
const minOutcomeTokensToBuy = outcomeTokensToBuy.mul(99).div(100);
await fpmm.buy(investmentAmount, outcomeIndex, minOutcomeTokensToBuy, { from: trader });
```

**结果**:
- 用户支付100 DAI
- 用户获得计算出的数量的"主队胜"结果代币
- 市场收取一定比例的手续费
- 市场自动调整各结果的价格：主队胜的价格上升，其他结果价格下降

### 4. 计算出售数量（calcSellAmount）

**功能**: 计算要获得指定数量的抵押品，需要出售多少特定结果代币。

**参数**:
- `returnAmount`: 期望获得的抵押品数量
- `outcomeIndex`: 要出售的结果索引

**示例场景**:

用户想知道如果要获得50 DAI，需要出售多少"主队胜"的结果代币。

```javascript
const returnAmount = web3.utils.toWei('50', 'ether');
const outcomeIndex = 0; // 主队胜
const outcomeTokensToSell = await fpmm.calcSellAmount(returnAmount, outcomeIndex);
console.log(`要获得50 DAI需要出售 ${web3.utils.fromWei(outcomeTokensToSell)} 个主队胜的结果代币`);
```

### 5. 出售结果代币（sell）

**功能**: 出售特定结果的代币以获取抵押品。

**参数**:
- `returnAmount`: 期望获得的抵押品数量
- `outcomeIndex`: 要出售的结果索引
- `maxOutcomeTokensToSell`: 愿意出售的最大代币数量(滑点保护)

**示例场景**:

用户持有"主队胜"的结果代币，但现在改变了想法，想卖出获取50 DAI。

```javascript
const returnAmount = web3.utils.toWei('50', 'ether');
const outcomeIndex = 0; // 主队胜
const outcomeTokensToSell = await fpmm.calcSellAmount(returnAmount, outcomeIndex);
// 设置1%的滑点保护
const maxOutcomeTokensToSell = outcomeTokensToSell.mul(101).div(100);
await fpmm.sell(returnAmount, outcomeIndex, maxOutcomeTokensToSell, { from: trader });
```

**结果**:
- 用户出售计算出数量的"主队胜"结果代币
- 用户获得50 DAI
- 市场收取一定比例的手续费
- 市场自动调整各结果的价格：主队胜的价格下降，其他结果价格上升

### 6. 移除流动性（removeFunding）

**功能**: 允许流动性提供者燃烧LP代币，按比例取回他们在所有结果代币池中的份额。

**参数**:
- `sharesToBurn`: 要燃烧的LP代币数量

**示例场景**:

投资者想取回部分投资，决定移除500个LP代币代表的流动性。

```javascript
const sharesToBurn = web3.utils.toWei('500', 'ether');
await fpmm.removeFunding(sharesToBurn, { from: investor });
```

**结果**:
- 投资者的500个LP代币被燃烧
- 投资者按比例获得各结果的代币
- 投资者也提取了对应比例的累积手续费

### 7. 查询累计手续费（collectedFees）

**功能**: 查询市场中尚未分配的累积手续费总额。

**示例**:
```javascript
const totalFees = await fpmm.collectedFees();
console.log(`市场中累积的总手续费: ${web3.utils.fromWei(totalFees)} DAI`);
```

### 8. 查询可提取手续费（feesWithdrawableBy）

**功能**: 查询特定地址可以提取的手续费金额。

**参数**:
- `account`: 要查询的账户地址

**示例**:
```javascript
const withdrawableFees = await fpmm.feesWithdrawableBy(investor);
console.log(`投资者可提取的手续费: ${web3.utils.fromWei(withdrawableFees)} DAI`);
```

### 9. 提取手续费（withdrawFees）

**功能**: 允许流动性提供者提取其应得的手续费。

**参数**:
- `account`: 提取手续费的账户地址

**示例**:
```javascript
await fpmm.withdrawFees(investor, { from: investor });
```

**结果**:
- 投资者获得其应得的手续费
- 更新投资者已提取的手续费记录

## 三、预测市场的回报机制

FPMM预测市场的核心在于：**不同结果的代币价格反映了市场对该结果发生概率的共识**。回报机制具有以下特点：

### 1. 概率与回报的反比关系

- **低概率事件 = 高回报**：市场认为越不可能发生的事件，如果确实发生，回报越高
- **高概率事件 = 低回报**：市场认为很可能发生的事件，回报相对较低

### 2. 回报计算示例

假设初始市场状态（总资金1000 DAI）：
- 主队胜: 1000个代币，50%概率
- 平局: 400个代币，20%概率
- 客队胜: 600个代币，30%概率

现在有三个用户分别投注：
- 用户A: 投入100 DAI购买约314个主队胜代币
- 用户B: 投入200 DAI购买约199个平局代币
- 用户C: 投入500 DAI购买约684个客队胜代币

结果确定后的回报：

1. **如果主队胜**:
   - 用户A持有314/686 ≈ 45.8%的主队胜代币
   - 总资金池约1800 DAI (1000+100+200+500)
   - 用户A获得约824 DAI (1800 × 45.8%)
   - 用户A净收益: 824 - 100 = 724 DAI (724%回报率)

2. **如果平局**:
   - 用户B持有199/301 ≈ 66.1%的平局代币
   - 总资金池约1800 DAI
   - 用户B获得约1190 DAI (1800 × 66.1%)
   - 用户B净收益: 1190 - 200 = 990 DAI (495%回报率)

3. **如果客队胜**:
   - 用户C持有684/216 ≈ 76%的客队胜代币
   - 总资金池约1800 DAI
   - 用户C获得约1368 DAI (1800 × 76%)
   - 用户C净收益: 1368 - 500 = 868 DAI (174%回报率)

可以看出，投注平局（低概率事件）的回报率最高，投注客队胜（中等概率事件）的回报率中等，而投注主队胜（高概率事件）的回报率虽然仍然可观，但相对较低。这体现了风险与回报的平衡。

### 3. 回报率影响因素

- **购买时机**: 越早购买最终获胜的结果代币，回报率通常越高
- **投资规模**: 大额交易会导致更明显的价格滑点，影响回报率
- **交易费用**: 影响净回报
- **市场对概率的共识**: 如果市场低估了某结果的真实概率，投注该结果可能获得更高回报

## 四、实际应用场景

### 场景1：创建和管理体育赛事预测市场

**步骤**:
1. 部署FPMM合约，设置手续费率为0.2%
2. 初始投资者添加10,000 DAI流动性，设置初始分布为[40, 20, 40]（主胜40%、平局20%、客胜40%）
3. 随着用户交易，市场价格自动调整反映实际赔率
4. 赛事结束后，结果确定为主队胜，条件令牌系统执行结算
5. 主队胜结果代币持有者获得赎回，其他结果代币变为无价值
6. 流动性提供者获得交易过程中产生的手续费

### 场景2：多条件组合预测市场

**示例**:
创建一个包含两个条件的市场：
- 条件1：球队A是否晋级（是/否）
- 条件2：球队B是否晋级（是/否）

这将创建4种可能的组合结果：
1. A晋级 & B晋级
2. A晋级 & B不晋级
3. A不晋级 & B晋级
4. A不晋级 & B不晋级

FPMM能够同时管理这四种结果的价格发现和做市。

## 五、FPMM的数学原理

### 恒定乘积公式

FPMM基于以下核心公式：

对于n个结果，其代币池余额分别为x₁, x₂, ..., xₙ，公式为：
```
x₁ * x₂ * ... * xₙ = k
```

其中k是一个常数，在交易前后保持不变（除非有流动性添加或移除）。

### 价格计算

结果i的价格（即市场隐含的概率）计算公式：
```
价格(i) = xi / (x₁ + x₂ + ... + xₙ)
```

### 购买计算示例

假设有一个二元市场（是/否），初始池余额均为1000代币：
1. 用户想购买"是"结果代币
2. 投入100单位抵押品（减去2%手续费 = 98）
3. 交易前：1000 * 1000 = 1,000,000 = k
4. 交易后：(1000 - y) * (1000 + 98) = 1,000,000
5. 解得y ≈ 89.08
6. 用户获得约89.08个"是"结果代币

### 结果确定后的回报计算

当某个结果确定为获胜结果后：
- 该结果的代币可以1:1赎回为抵押品
- 市场中所有抵押品将按比例分配给获胜结果代币的持有者
- 例如：如果用户持有50%的获胜结果代币，将获得市场中50%的抵押品

## 六、优势与局限性

### 优势
- **自动化**: 无需人工干预的价格发现和做市
- **可扩展性**: 支持任意数量的结果和条件组合
- **激励一致**: 流动性提供者通过收取交易费用获得回报
- **公平回报**: 低概率事件提供更高回报，符合风险-回报平衡
- **资本灵活性**: 允许LP随时加入或退出，无需锁定期

### 局限性
- **资本效率**: 需要为每个可能结果提供流动性，资本利用效率不高
- **价格操纵**: 在流动性较低时，容易被大额交易操纵价格
- **无风险套利**: 在某些多结果市场中可能存在无风险套利机会
- **初始市场**: 初始分布设置对后续市场价格有重要影响

## 七、与其他做市商机制的比较

| 特性 | FPMM | LMSR | 订单簿 |
|------|------|------|-------|
| 自动化程度 | 高 | 高 | 低 |
| 资本效率 | 中 | 低 | 高 |
| 滑点 | 存在且可预测 | 存在且可预测 | 取决于订单深度 |
| 初始设置复杂度 | 低 | 中 | 高 |
| 适用场景 | 一般预测市场 | 非营利预测市场 | 高流动性市场 |
| 算法复杂度 | 中等 | 高 | 低 |

## 八、总结

FixedProductMarketMaker提供了一个强大且灵活的框架，用于创建和管理预测市场。它通过恒定乘积公式实现自动化价格发现，使用户能够轻松交易各种事件的结果代币。流动性提供者可以通过添加资金并收取交易费用来获得回报，同时帮助市场保持流动性和价格稳定。

FPMM的关键特点是它能够为不同概率的事件提供合理的回报结构——低概率事件提供高回报，高概率事件提供低回报——这符合金融市场的风险-回报原则。这种机制使得预测市场能够有效聚合集体智慧，为各种事件的概率提供可靠的估计。

### case
在FPMM中，购买概率较低的结果（如平局）应该具有更高的潜在回报。这是因为：
池中平局代币余额较低(400)，表示市场认为平局概率较低
当您购买平局代币时，您支付的价格相对较低（反映了低概率）
如果平局实际发生，您的回报会很高（因为所有资金将在少数平局代币持有者之间分配）
重新计算市场情况
让我们使用正确的方法重新分析用户B购买平局代币的情况：
初始市场（用户A交易后）
主队胜池: 685.71 代币
平局池: 500 代币
客队胜池: 700 代币
总投资: 1000 + 100 = 1100 DAI
用户B购买平局代币（投入200 DAI）
用户B支付200 DAI
可购买的平局代币 ≈ 199.25 个
如果平局确实发生：
市场中有1300 DAI (1100 + 200)
平局代币总数 ≈ 300.75 (500 - 199.25)
用户B拥有 199.25/300.75 ≈ 66.3%的平局代币
用户B可获得约 1300 * 66.3% ≈ 862 DAI
净收益: 862 - 200 = 662 DAI (331%回报率)